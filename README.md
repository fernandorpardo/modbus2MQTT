# modbus2MQTT
[![Apache-2.0 license](https://img.shields.io/badge/License-Apache_2.0-green.svg?style=flat-square)](https://www.apache.org/licenses/LICENSE-2.0)
[![ESP32](https://img.shields.io/badge/ESP-32-green.svg?style=flat-square)](https://www.espressif.com/en/products/socs/esp32)

The project consists of the implementation of the modbus protocol over serial interface to get the measures from two wattmeters and translating the data into MQTT publish messages sent to a MQTT broker such as [Mosquitto](https://mosquitto.org).


## The problem to solve

The picture shows a simple installation of a home solar system for self-consumption, that is the test environment for this project.
<img width="1048" height="463" alt="image1" src="https://github.com/user-attachments/assets/467d5268-9b55-413b-9287-58fdb08aeef7" />

I wanted to read the power measures and calculate the excess power to turn on and off the home appliances accordingly.

The first thing I tried was getting the values through the inverter’s API but for that you need an “API account” and the manufacturer declines to provide me with it, so I took the path explained here.

We need to measure the power generated by the inverter and the power from the grid. Home consumption is calculated from these two values.

We have already a DDSU666-H wattmeter at the grid side from which we can get the measures of the power coming in and out to the grid. To avoid interfering the dialogue between inverter and wattmeter we don’t generate traffic at this side but sniff the responses. RS-485 is not a point-to-point connection but a bus so other devices can be added.

On the inverter side, we need to add a wattmeter. The one here is an Eastron SDM120CT-MV and in this case Tx and Rx are wired.

The add-ons to the installation are the ones in red colour in the picture above.


## HW module
The HW module is made of an ESP-WROOM-32 connected to the wattmeters through two TTL to RS-485 modules: through UART1 (pins 17 and 16) to the DDSU666-H and UART2 (pins 14 and 13) to the SDM120CT. 

<img width="1175" height="491" alt="image2" src="https://github.com/user-attachments/assets/92f1dd6c-d45f-463d-bce8-f1bb95fa5194" />


## Code
The source is in C language 

The development environmentis the ESP-IDF. I am running ESP-IDF v5.4-dev-2194-gd7ca8b94c8 for Linux on a Raspberry Pi.

The IP connection is through Wi-Fi. You need to set your SSID and password in the file config.h

```
// WiFi
#define	WIFI_SSID	    "YOUR_SSID"
#define	WIFI_PASSWORD	"THE_PASSWORD_OF_YOUR_SSID"
```

The SW is expecting an MQTT broker to publish the measurements. 
So you need to overwrite the IP address and Port of your MQTT server.
```
// Mosquitto address
#define MQTT_HOST_IP_ADDR 	"192.168.1.2"
#define MQTT_HOST_IP_PORT 	1883		// default Mosquitto port
```

And if you want, modify the MQTT device name.
```
#define DEVICE_MQTT_NAME	"modbus2mqtt"
```


## Build
Follow the regular process to generate and flash the code as described in the ESP IDF instructions ["Configure Your Projec"](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/linux-macos-setup.html#configure-your-project)

Run ESP-IDF script to make the tools usable from the command line and set the necessary environment variables.
```console
. $HOME/esp/esp-idf/export.sh
```
Go to your project directory, e.g.
```console
cd ~/esp/modbus2MQTT
```
Select your target
```console
idf.py set-target esp32
```
You can skip the menuconfig for the are no project specific variables to set up
```console
idf.py menuconfig
```
Compile and generate the code
```console
idf.py build
```
Execute (choose the right port for your enviroment)
```console
idf.py -p /dev/ttyUSB1 flash monitor
```


## Test
Use an MQTT client to cusbscribe to the MQTT topic to receive the PUBLISH messages. You can use the Mosquitto client and the mosquitto_sub command as follows

```console
mosquitto_sub -d -t 'modbus2mqtt/set'

Client null sending CONNECT
Client null received CONNACK (0)
Client null sending SUBSCRIBE (Mid: 1, Topic: modbus2mqtt/set, QoS: 0, Options: 0x00)
Client null received SUBACK
Subscribed (mid: 1): 0
Client null received PUBLISH (d0, q0, r0, m0, 'modbus2mqtt/set', ... (64 bytes))
{"SDM120CT":{"v":"228.80","c":"0.00","ap":"-0.00","rp":"28.80"}}
Client null received PUBLISH (d0, q0, r0, m0, 'modbus2mqtt/set', ... (67 bytes))
{"DDSU666H":{"v":"228.60","c":"1.99","ap":"363.50","rp":"-272.70"}}
```

The Mosquitto client is an optional installation. Run the following to install it.
```console
sudo apt install -y mosquitto mosquitto-clients
```
